<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>RCN Credit Marketplace - Documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/material.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">RCN Credit Marketplace - Documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content class">
                   <div class="content-data">











<ol class="breadcrumb">
  <li>Classes</li>
  <li>Tx</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/services/tx.service.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#confirmed">confirmed</a>
                            </li>
                            <li>
                                <a href="#data">data</a>
                            </li>
                            <li>
                                <a href="#timestamp">timestamp</a>
                            </li>
                            <li>
                                <a href="#to">to</a>
                            </li>
                            <li>
                                <a href="#tx">tx</a>
                            </li>
                            <li>
                                <a href="#type">type</a>
                            </li>
                        </ul>
                    </td>
                </tr>






        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(tx: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, to: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, confirmed: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank">Boolean</a>, type: <a href="../undefineds/Type.html">Type</a>, data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="24" class="link-to-prism">src/app/services/tx.service.ts:24</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>tx</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>to</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>confirmed</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank" >Boolean</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>type</td>
                                                  
                                                        <td>
                                                                        <code><a href="../miscellaneous/enumerations.html#Type" target="_self" >Type</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>data</td>
                                                  
                                                        <td>
                                                                        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
        <h3 id="inputs">
            Properties
        </h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="confirmed"></a>
                        <span class="name">
                            <b>
                            confirmed</b>
                            <a href="#confirmed"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean" target="_blank" >Boolean</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="21" class="link-to-prism">src/app/services/tx.service.ts:21</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="data"></a>
                        <span class="name">
                            <b>
                            data</b>
                            <a href="#data"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="23" class="link-to-prism">src/app/services/tx.service.ts:23</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="timestamp"></a>
                        <span class="name">
                            <b>
                            timestamp</b>
                            <a href="#timestamp"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="24" class="link-to-prism">src/app/services/tx.service.ts:24</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="to"></a>
                        <span class="name">
                            <b>
                            to</b>
                            <a href="#to"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="20" class="link-to-prism">src/app/services/tx.service.ts:20</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="tx"></a>
                        <span class="name">
                            <b>
                            tx</b>
                            <a href="#tx"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="19" class="link-to-prism">src/app/services/tx.service.ts:19</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
                        <a name="type"></a>
                        <span class="name">
                            <b>
                            type</b>
                            <a href="#type"><span class="icon ion-ios-link"></span></a>
                        </span>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                            <i>Type : </i>        <code><a href="../miscellaneous/enumerations.html#Type" target="_self" >Type</a></code>

                        </td>
                    </tr>
                        <tr>
                            <td class="col-md-4">
                                    <div class="io-line">Defined in <a href="" data-line="22" class="link-to-prism">src/app/services/tx.service.ts:22</a></div>
                            </td>
                        </tr>


            </tbody>
        </table>
</section>







    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">declare let window: any;

import { Injectable } from &#x27;@angular/core&#x27;;
import { MatSnackBar } from &#x27;@angular/material&#x27;;
import { Loan } from &#x27;./../models/loan.model&#x27;;
import { Web3Service } from &#x27;./web3.service&#x27;;
import { EventsService, Category } from &#x27;./events.service&#x27;;

export enum Type {
  lend &#x3D; &#x27;lend&#x27;,
  approve &#x3D; &#x27;approve&#x27;,
  withdraw &#x3D; &#x27;withdraw&#x27;,
  transfer &#x3D; &#x27;transfer&#x27;,
  claim &#x3D; &#x27;claim&#x27;,
  pay &#x3D; &#x27;pay&#x27;
}

export class Tx {
  tx: string;
  to: string;
  confirmed: Boolean;
  type: Type;
  data: any;
  timestamp: number;

  constructor(
    tx: string,
    to: string,
    confirmed: Boolean,
    type: Type,
    data: any
  ) {
    this.tx &#x3D; tx;
    this.to &#x3D; to;
    this.confirmed &#x3D; confirmed;
    this.type &#x3D; type;
    this.data &#x3D; data;
    this.timestamp &#x3D; new Date().getTime();
  }
}

@Injectable({
  providedIn: &#x27;root&#x27;
})
export class TxService {
  private txKey &#x3D; &#x27;tx&#x27;;
  txMemory: Tx[];

  private localStorage: any;

  // tslint:disable-next-line:no-unused-variable
  private interval: any;

  private newTxSubscribers: ((tx: Tx) &#x3D;&gt; void)[] &#x3D; [];
  private confirmedTxSubscribers: ((tx: Tx) &#x3D;&gt; void)[] &#x3D; [];

  constructor(
    private web3service: Web3Service,
    private eventsService: EventsService,
    public snackBar: MatSnackBar
  ) {
    this.localStorage &#x3D; window.localStorage;
    this.txMemory &#x3D; this.readTxs();
    if (this.txMemory &#x3D;&#x3D;&#x3D; null) {
      this.txMemory &#x3D; [];
    }

    // Start confirmations loop
    this.interval &#x3D; setInterval(() &#x3D;&gt; {
      this.checkUpdate();
    }, 5000);
  }

  subscribeNewTx(cb: (tx: Tx) &#x3D;&gt; void) {
    if (!this.newTxSubscribers.find(c &#x3D;&gt; c &#x3D;&#x3D;&#x3D; cb)) {
      this.newTxSubscribers.push(cb);
    }
  }

  subscribeConfirmedTx(cb: (tx: Tx) &#x3D;&gt; void) {
    if (!this.confirmedTxSubscribers.find(c &#x3D;&gt; c &#x3D;&#x3D;&#x3D; cb)) {
      this.confirmedTxSubscribers.push(cb);
    }
  }

  unsubscribeConfirmedTx(cb: (tx: Tx) &#x3D;&gt; void) {
    this.confirmedTxSubscribers &#x3D; this.confirmedTxSubscribers.filter(c &#x3D;&gt; c.toString() !&#x3D;&#x3D; cb.toString());
  }

  registerTx(tx: Tx) {
    this.txMemory.push(tx);
    this.newTxSubscribers.forEach(c &#x3D;&gt; c(tx));
    this.saveTxs();
  }

  registerLendTx(tx: string, engine: string, loan: Loan) {
    const data &#x3D; {
      engine: engine,
      id: loan.id
    };
    this.registerTx(new Tx(tx, engine, false, Type.lend, data));
  }

  getPendingTxs(): Tx[] {
    return this.txMemory.filter(tx &#x3D;&gt; !tx.confirmed);
  }

  getPastTxs(count: number): Tx[] {
    return this.txMemory
      .filter(tx &#x3D;&gt; tx.confirmed)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)
      .slice(0, count);
  }

  getLastPendingLend(loan: Loan): Tx {
    return this.txMemory
      .filter(tx &#x3D;&gt; !tx.confirmed)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)
      .find(tx &#x3D;&gt; tx.type &#x3D;&#x3D;&#x3D; Type.lend &amp;&amp; tx.data.id &#x3D;&#x3D;&#x3D; loan.id &amp;&amp; loan.address &#x3D;&#x3D;&#x3D; tx.to);
  }

  registerApproveTx(tx: string, token: string, contract: string, action: boolean) {
    const data &#x3D; { contract: contract, action: action };
    this.registerTx(new Tx(tx, token, false, Type.approve, data));
  }

  getLastPendingApprove(token: string, contract: string): Tx {
    return this.txMemory
      .filter(tx &#x3D;&gt; !tx.confirmed)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)
      .find(tx &#x3D;&gt; tx.type &#x3D;&#x3D;&#x3D; Type.approve &amp;&amp; tx.data.contract &#x3D;&#x3D;&#x3D; contract &amp;&amp; tx.to &#x3D;&#x3D;&#x3D; token);
  }

  registerWithdrawTx(tx: string, engine: string, loans: number[]) {
    this.registerTx(new Tx(tx, engine, false, Type.withdraw, loans));
  }

  getLastWithdraw(engine: string, loans: number[]): Tx {
    return this.txMemory
      .filter(tx &#x3D;&gt; !tx.confirmed &amp;&amp; tx.type &#x3D;&#x3D;&#x3D; Type.withdraw)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)
      .find(tx &#x3D;&gt; tx.to &#x3D;&#x3D;&#x3D; engine &amp;&amp; tx.data.toString() &#x3D;&#x3D;&#x3D; loans.toString());
  }

  registerTransferTx(tx: string, engine: string, loan: Loan, to: string) {
    const data &#x3D; {
      id: loan.id,
      to: to
    };
    this.registerTx(new Tx(tx, engine, false, Type.transfer, data));
  }

  getLastPendingTransfer(engine: string, loan: Loan): Tx {
    return this.txMemory
      .filter(tx &#x3D;&gt; !tx.confirmed &amp;&amp; tx.type &#x3D;&#x3D;&#x3D; Type.transfer &amp;&amp; tx.to &#x3D;&#x3D;&#x3D; engine)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)
      .find(tx &#x3D;&gt; tx.data.id &#x3D;&#x3D;&#x3D; loan.id);
  }

  registerClaimTx(tx: string, cosigner: string, loan: Loan) {
    const data &#x3D; {
      engine: loan.address,
      id: loan.id
    };

    this.registerTx(new Tx(tx, cosigner, false, Type.claim, data));
  }

  getLastPendingClaim(cosigner: string, loan: Loan) {
    return this.txMemory
      .filter(tx &#x3D;&gt; !tx.confirmed &amp;&amp; tx.type &#x3D;&#x3D;&#x3D; Type.claim &amp;&amp; tx.to &#x3D;&#x3D;&#x3D; cosigner)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)
      .find(tx &#x3D;&gt; tx.data.id &#x3D;&#x3D;&#x3D; loan.id &amp;&amp; tx.data.engine &#x3D;&#x3D;&#x3D; loan.address);
  }

  registerPayTx(tx: string, engine: string, loan: Loan, amount: number) {
    const data &#x3D; {
      engine: engine,
      id: loan.id,
      amount: amount
    };
    this.registerTx(new Tx(tx, engine, false, Type.pay, data));
  }

  getLastPendingPay(loan: Loan) {
    return this.txMemory
      .filter(tx &#x3D;&gt;
        !tx.confirmed &amp;&amp;
        tx.type &#x3D;&#x3D;&#x3D; Type.pay &amp;&amp;
        tx.data.id &#x3D;&#x3D;&#x3D; loan.id)
      .sort((tx1, tx2) &#x3D;&gt; tx2.timestamp - tx1.timestamp)[0];
  }

  openSnackBar(message: string, action: string) {
    this.snackBar.open(message , action, {
      duration: 4000
    });
  }

  private checkUpdate() {
    this.txMemory.forEach(tx &#x3D;&gt; {
      if (!tx.confirmed) {
        this.web3service.web3.eth.getTransactionReceipt(tx.tx, (_err, receipt) &#x3D;&gt; {
          if (receipt !&#x3D;&#x3D; null) {
            if (tx.type &#x3D;&#x3D;&#x3D; Type.lend) { this.openSnackBar(&#x27;Lent Successfully&#x27;, &#x27;&#x27;); }
            console.info(&#x27;Found receipt tx&#x27;, tx, receipt);
            this.eventsService.trackEvent(
              &#x27;confirmed-transaction-&#x27; + tx.type,
              Category.Transaction,
              tx.tx,
              0, true
            );
            tx.confirmed &#x3D; true;
            this.confirmedTxSubscribers.forEach(c &#x3D;&gt; c(tx));
            this.saveTxs();
          }
        });
      }
    });
  }

  private saveTxs() {
    this.localStorage.setItem(this.txKey, JSON.stringify(this.txMemory));
  }

  private readTxs(): any {
    return JSON.parse(this.localStorage.getItem(this.txKey));
  }
}
</code></pre>
    </div>
</div>



                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'class';
            var COMPODOC_CURRENT_PAGE_URL = 'Tx.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
